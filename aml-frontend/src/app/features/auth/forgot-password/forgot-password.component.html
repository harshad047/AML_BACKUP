<div class="login-container">
  <div class="login-box">
    
    <div class="login-form">
      <div [ngSwitch]="currentStep">

        <div *ngSwitchCase="'email'">
          <div class="text-center mb-4">
            <h2 class="fw-bold text-primary">Secure Account Recovery</h2>
            <p class="text-muted">Enter your email to begin the secure recovery process.</p>
          </div>

          <div *ngIf="error" class="alert alert-danger" role="alert">{{ error }}</div>
          <div *ngIf="success" class="alert alert-success" role="alert">{{ success }}</div>

          <form [formGroup]="emailForm" (ngSubmit)="sendOtp()">
            <div class="mb-3">
              <label for="email" class="form-label">Email address</label>
              <input 
                type="email" 
                class="form-control form-control-lg" 
                id="email" 
                formControlName="email"
                placeholder="Enter your registered email" 
                [class.is-invalid]="isFieldInvalid(emailForm, 'email')"
              >
              <div class="invalid-feedback" *ngIf="isFieldInvalid(emailForm, 'email')">
                Please enter a valid email address.
              </div>
            </div>

            <div class="d-grid">
              <button type="submit" class="btn btn-primary btn-lg" [disabled]="emailForm.invalid || loading">
                <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                {{ loading ? 'Sending...' : 'Send Security Code' }}
              </button>
            </div>
          </form>

          <div class="text-center mt-3">
            <a routerLink="/auth/login" class="text-decoration-none fw-bold">Back to Login</a>
          </div>
        </div>

        <div *ngSwitchCase="'otp'">
          <div class="text-center mb-4">
            <h2 class="fw-bold text-primary">Verify Your Identity</h2>
            <p class="text-muted">For your security, a verification code has been sent to <strong>{{ verifiedEmail }}</strong></p>
          </div>

          <div *ngIf="error" class="alert alert-danger" role="alert">{{ error }}</div>

          <form [formGroup]="otpForm" (ngSubmit)="verifyOtp()">
            <div class="mb-3">
              <label for="otp" class="form-label">Verification Code</label>
              <input 
                type="text" 
                class="form-control form-control-lg text-center" 
                id="otp" 
                formControlName="otp"
                placeholder="Enter 6-digit code" 
                [class.is-invalid]="isFieldInvalid(otpForm, 'otp')"
              >
              <div class="invalid-feedback" *ngIf="isFieldInvalid(otpForm, 'otp')">
                Please enter a valid 6-digit code.
              </div>
            </div>

            <div class="d-grid">
              <button type="submit" class="btn btn-primary btn-lg" [disabled]="otpForm.invalid || loading">
                <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                {{ loading ? 'Verifying...' : 'Verify Identity' }}
              </button>
            </div>
          </form>

          <div class="d-flex justify-content-between mt-3">
            <a (click)="goBackToEmail()" class="text-decoration-none">Use a different email</a>
            <a (click)="resendOtp()" class="text-decoration-none fw-bold">Resend Code</a>
          </div>
        </div>

        <div *ngSwitchCase="'password'">
          <div class="text-center mb-4">
            <h2 class="fw-bold text-primary">Set New Password</h2>
            <p class="text-muted">Create a strong, new password to protect your account.</p>
          </div>

          <div *ngIf="error" class="alert alert-danger" role="alert">{{ error }}</div>
          <div *ngIf="success" class="alert alert-success" role="alert">{{ success }}</div>

          <form [formGroup]="passwordForm" (ngSubmit)="resetPassword()">
            <div class="mb-3">
              <label for="newPassword" class="form-label">New Password</label>
              <div class="input-group input-group-lg">
                <input 
                  [type]="showNewPassword ? 'text' : 'password'" 
                  class="form-control" 
                  id="newPassword" 
                  formControlName="newPassword" 
                  placeholder="Enter a strong password"
                  [class.is-invalid]="isFieldInvalid(passwordForm, 'newPassword')"
                >
                <button class="btn btn-outline-secondary" type="button" (click)="toggleNewPasswordVisibility()">
                  <i class="fas" [class.fa-eye]="!showNewPassword" [class.fa-eye-slash]="showNewPassword"></i>
                </button>
              </div>
              <div class="invalid-feedback d-block" *ngIf="isFieldInvalid(passwordForm, 'newPassword')">
                <div *ngIf="passwordForm.get('newPassword')?.errors?.['required']">
                  Password is required.
                </div>
                <div *ngIf="passwordForm.get('newPassword')?.errors?.['minlength']">
                  Password must be at least 8 characters long.
                </div>
                <div *ngIf="passwordForm.get('newPassword')?.errors?.['strongPassword']">
                  <strong>Password must contain:</strong>
                  <ul class="mb-0 mt-1" style="font-size: 0.875rem;">
                    <li [class.text-success]="passwordForm.get('newPassword')?.errors?.['strongPassword']?.hasUpperCase" 
                        [class.text-danger]="!passwordForm.get('newPassword')?.errors?.['strongPassword']?.hasUpperCase">
                      At least one uppercase letter (A-Z)
                    </li>
                    <li [class.text-success]="passwordForm.get('newPassword')?.errors?.['strongPassword']?.hasLowerCase" 
                        [class.text-danger]="!passwordForm.get('newPassword')?.errors?.['strongPassword']?.hasLowerCase">
                      At least one lowercase letter (a-z)
                    </li>
                    <li [class.text-success]="passwordForm.get('newPassword')?.errors?.['strongPassword']?.hasNumeric" 
                        [class.text-danger]="!passwordForm.get('newPassword')?.errors?.['strongPassword']?.hasNumeric">
                      At least one digit (0-9)
                    </li>
                    <li [class.text-success]="passwordForm.get('newPassword')?.errors?.['strongPassword']?.hasSpecialChar" 
                        [class.text-danger]="!passwordForm.get('newPassword')?.errors?.['strongPassword']?.hasSpecialChar">
                      At least one special character (!&#64;#$%^&*...)
                    </li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label for="confirmPassword" class="form-label">Confirm New Password</label>
              <div class="input-group input-group-lg">
                <input 
                  [type]="showConfirmPassword ? 'text' : 'password'" 
                  class="form-control" 
                  id="confirmPassword" 
                  formControlName="confirmPassword" 
                  placeholder="Confirm your new password"
                  [class.is-invalid]="isFieldInvalid(passwordForm, 'confirmPassword') || (passwordForm.get('confirmPassword')?.touched && passwordForm.errors?.['passwordMismatch'])"
                >
                <button class="btn btn-outline-secondary" type="button" (click)="toggleConfirmPasswordVisibility()">
                  <i class="fas" [class.fa-eye]="!showConfirmPassword" [class.fa-eye-slash]="showConfirmPassword"></i>
                </button>
              </div>
              <div class="invalid-feedback d-block" *ngIf="passwordForm.get('confirmPassword')?.touched && passwordForm.errors?.['passwordMismatch']">
                Passwords do not match.
              </div>
            </div>

            <div class="d-grid">
              <button type="submit" class="btn btn-primary btn-lg" [disabled]="passwordForm.invalid || loading">
                <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                {{ loading ? 'Updating...' : 'Update Password' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="login-branding">
      <div class="branding-content">
        <div class="simple-branding">
          <div class="rupee-circle">
            <i class="fas fa-shield-alt" style="font-size: 3.5rem; color: #0d6efd;"></i>
          </div>
          <h1>Secure Account Recovery</h1>
          <p class="subtitle">Anti-Money Laundering Platform</p>
          <div class="divider"></div>
            <p class="description">
            Forgot your password? It happens. Our secure recovery system is designed to get you back into your account quickly and safely. Just follow the prompts.
            </p>
        </div>
      </div>
    </div>
  </div>
</div>