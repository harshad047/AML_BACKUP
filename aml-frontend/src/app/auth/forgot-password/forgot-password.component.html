<div class="forgot-password-container">
  <div class="forgot-password-box">
    <div class="forgot-password-form">
      <!-- Header -->
      <div class="text-center mb-4">
        <h2 class="fw-bold text-primary">Reset Password</h2>
        <p class="text-muted">
          <span *ngIf="currentStep === 'email'">Enter your email to receive an OTP</span>
          <span *ngIf="currentStep === 'otp'">Enter the OTP sent to your email</span>
          <span *ngIf="currentStep === 'reset'">Create a new password</span>
        </p>
      </div>

      <!-- Success Message -->
      <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>{{ successMessage }}
        <button type="button" class="btn-close" (click)="successMessage = ''" aria-label="Close"></button>
      </div>

      <!-- Error Message -->
      <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>{{ errorMessage }}
        <button type="button" class="btn-close" (click)="errorMessage = ''" aria-label="Close"></button>
      </div>

      <!-- Step 1: Email Input -->
      <form *ngIf="currentStep === 'email'" [formGroup]="emailForm" (ngSubmit)="onSendOtp()">
        <div class="mb-3">
          <label for="email" class="form-label">Email Address</label>
          <div class="input-group input-group-lg">
            <span class="input-group-text">
              <i class="fas fa-envelope"></i>
            </span>
            <input
              type="email"
              class="form-control"
              id="email"
              formControlName="email"
              placeholder="Enter your registered email"
              [class.is-invalid]="isFieldInvalid(emailForm, 'email')"
            >
          </div>
          <div class="invalid-feedback" *ngIf="isFieldInvalid(emailForm, 'email')">
            Please enter a valid email address
          </div>
        </div>

        <div class="d-grid gap-2">
          <button
            type="submit"
            class="btn btn-primary btn-lg"
            [disabled]="emailForm.invalid || isLoading"
          >
            <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            {{ isLoading ? 'Sending OTP...' : 'Send OTP' }}
          </button>
          <a routerLink="/login" class="btn btn-outline-secondary btn-lg">
            <i class="fas fa-arrow-left me-2"></i>Back to Login
          </a>
        </div>
      </form>

      <!-- Step 2: OTP Verification -->
      <form *ngIf="currentStep === 'otp'" [formGroup]="otpForm" (ngSubmit)="onVerifyOtp()">
        <div class="mb-3">
          <label for="otp" class="form-label">Enter OTP</label>
          <div class="input-group input-group-lg">
            <span class="input-group-text">
              <i class="fas fa-key"></i>
            </span>
            <input
              type="text"
              class="form-control text-center"
              id="otp"
              formControlName="otp"
              placeholder="Enter 6-digit OTP"
              maxlength="6"
              [class.is-invalid]="isFieldInvalid(otpForm, 'otp')"
            >
          </div>
          <div class="invalid-feedback" *ngIf="isFieldInvalid(otpForm, 'otp')">
            Please enter a valid 6-digit OTP
          </div>
          <div class="form-text text-center mt-2">
            OTP sent to: <strong>{{ email }}</strong>
          </div>
        </div>

        <!-- Resend OTP -->
        <div class="text-center mb-3">
          <button
            type="button"
            class="btn btn-link text-decoration-none"
            [disabled]="otpTimer > 0 || isLoading"
            (click)="onResendOtp()"
          >
            <i class="fas fa-redo me-1"></i>
            <span *ngIf="otpTimer > 0">Resend OTP in {{ otpTimer }}s</span>
            <span *ngIf="otpTimer === 0">Resend OTP</span>
          </button>
        </div>

        <div class="d-grid gap-2">
          <button
            type="submit"
            class="btn btn-primary btn-lg"
            [disabled]="otpForm.invalid || isLoading"
          >
            <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            {{ isLoading ? 'Verifying...' : 'Verify OTP' }}
          </button>
          <button
            type="button"
            class="btn btn-outline-secondary btn-lg"
            (click)="goBack()"
            [disabled]="isLoading"
          >
            <i class="fas fa-arrow-left me-2"></i>Back
          </button>
        </div>
      </form>

      <!-- Step 3: Reset Password -->
      <form *ngIf="currentStep === 'reset'" [formGroup]="resetForm" (ngSubmit)="onResetPassword()">
        <div class="mb-3">
          <label for="newPassword" class="form-label">New Password</label>
          <div class="input-group input-group-lg">
            <span class="input-group-text">
              <i class="fas fa-lock"></i>
            </span>
            <input
              [type]="showNewPassword ? 'text' : 'password'"
              class="form-control"
              id="newPassword"
              formControlName="newPassword"
              placeholder="Enter new password"
              [class.is-invalid]="isFieldInvalid(resetForm, 'newPassword')"
            >
            <button
              class="btn btn-outline-secondary"
              type="button"
              (click)="togglePasswordVisibility('new')"
              [attr.aria-label]="showNewPassword ? 'Hide password' : 'Show password'"
            >
              <i class="fas" [class.fa-eye]="!showNewPassword" [class.fa-eye-slash]="showNewPassword"></i>
            </button>
          </div>
          <div class="invalid-feedback" *ngIf="isFieldInvalid(resetForm, 'newPassword')">
            Password must be at least 8 characters long
          </div>
          
          <!-- Password Strength Indicator -->
          <div class="password-strength mt-2" *ngIf="resetForm.get('newPassword')?.value">
            <div class="strength-bar">
              <div 
                class="strength-fill" 
                [class.weak]="getPasswordStrength() === 'weak'"
                [class.medium]="getPasswordStrength() === 'medium'"
                [class.strong]="getPasswordStrength() === 'strong'"
              ></div>
            </div>
            <small class="text-muted">
              Password strength: 
              <span [class.text-danger]="getPasswordStrength() === 'weak'">
                <span [class.text-warning]="getPasswordStrength() === 'medium'">
                  <span [class.text-success]="getPasswordStrength() === 'strong'">
                    {{ getPasswordStrength() | titlecase }}
                  </span>
                </span>
              </span>
            </small>
          </div>
        </div>

        <div class="mb-3">
          <label for="confirmPassword" class="form-label">Confirm Password</label>
          <div class="input-group input-group-lg">
            <span class="input-group-text">
              <i class="fas fa-lock"></i>
            </span>
            <input
              [type]="showConfirmPassword ? 'text' : 'password'"
              class="form-control"
              id="confirmPassword"
              formControlName="confirmPassword"
              placeholder="Confirm new password"
              [class.is-invalid]="isFieldInvalid(resetForm, 'confirmPassword') || resetForm.hasError('passwordMismatch')"
            >
            <button
              class="btn btn-outline-secondary"
              type="button"
              (click)="togglePasswordVisibility('confirm')"
              [attr.aria-label]="showConfirmPassword ? 'Hide password' : 'Show password'"
            >
              <i class="fas" [class.fa-eye]="!showConfirmPassword" [class.fa-eye-slash]="showConfirmPassword"></i>
            </button>
          </div>
          <div class="invalid-feedback" *ngIf="resetForm.hasError('passwordMismatch') && resetForm.get('confirmPassword')?.touched">
            Passwords do not match
          </div>
        </div>

        <div class="d-grid gap-2">
          <button
            type="submit"
            class="btn btn-primary btn-lg"
            [disabled]="resetForm.invalid || isLoading"
          >
            <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            {{ isLoading ? 'Resetting Password...' : 'Reset Password' }}
          </button>
          <button
            type="button"
            class="btn btn-outline-secondary btn-lg"
            (click)="goBack()"
            [disabled]="isLoading"
          >
            <i class="fas fa-arrow-left me-2"></i>Back
          </button>
        </div>
      </form>

      <!-- Additional Links -->
      <div class="text-center mt-4">
        <p class="mb-0">Remember your password?
          <a routerLink="/login" class="text-decoration-none fw-bold">Sign in</a>
        </p>
      </div>
    </div>

    <!-- Branding Section -->
    <div class="forgot-password-branding">
      <div class="branding-content">
        <div class="simple-branding">
          <div class="rupee-circle">
            <span class="rupee-symbol">â‚¹</span>
          </div>
          <h1>Secure Account Recovery</h1>
          <p class="subtitle">AML System</p>
          <div class="divider"></div>
          <p class="description">
            Your account security is our priority. Follow the simple steps to reset your password securely.
          </p>
          <div class="security-features">
            <div class="feature-item">
              <i class="fas fa-shield-alt"></i>
              <span>Secure OTP Verification</span>
            </div>
            <div class="feature-item">
              <i class="fas fa-lock"></i>
              <span>Encrypted Password Reset</span>
            </div>
            <div class="feature-item">
              <i class="fas fa-clock"></i>
              <span>Time-Limited OTP</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
